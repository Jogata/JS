<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AJAX | XMLHttpRequest</title>
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> -->
  </head>
  <body>
    <h1><span>AJAX</span> XMLHttpRequest(HTTPMethod, url, )</h1>

    <!-- ================= Get data from local JSON file ================= -->

    <fieldset>
      <legend>Get all users from local JSON file</legend>
      <button id="local">Send Request</button>
    </fieldset>

    <script>
      const btnLocalJSON = document.querySelector("#local");
      btnLocalJSON.addEventListener("click", getAllUsersFromLocalFile);

      function getAllUsersFromLocalFile() {
        const users = new XMLHttpRequest();

        users.onload = function () {
          if (this.status === 200) {
            try {
              const responseAsObject = JSON.parse(this.responseText);
            } catch (error) {
              console.warn('Did not parse the data!');
            }
          } else {
            console.warn('Did not receive the data!');
          }
        };
  
        users.open('get', 'users.js', true);
        users.send();
      }
    </script>

    <!-- ================= Get data from GitHub API ================= -->
    <fieldset>
      <legend>Get users from GitHub API</legend>
      <button id="github">Send Request</button>
      <span id="userGithub"></span>
    </fieldset>

    <script>
      const btnGithub = document.querySelector("#github");
      btnGithub.addEventListener("click", getUsersFromGithub);

      function getUsersFromGithub() {
        const users = new XMLHttpRequest();

        users.onload = function () {
          if (this.status === 200) {
            try {
              const usersAsArray = JSON.parse(this.responseText);
              const display = document.querySelector("#userGithub");
              const randomIndex = Math.floor(Math.random() * 30);
              display.textContent = usersAsArray[randomIndex].login;
            } catch (error) {
              console.warn('Did not parse the data!');
            }
          } else {
            console.warn('Did not receive the data!');
          }
        };
  
        users.open('get', 'https://api.github.com/users', true);
        users.send();
      }
    </script>

    <script>
      // 09. Arena Tier✶

      function arenaFights(params) {
        const gladiators = {};
        let index = 0;
        let input = params[index];
      
        while (input != "Ave Cesar") {
          const data = input.split(" -> ");
          // console.log(data);

          if (data.length == 3) {
            const name = data[0];
            const technique = data[1];
            const skill = Number(data[2]);
            // console.log(name);
            // console.log(technique);
            // console.log(skill);
            
            const gladiatorData = {
              // name, 
              [technique]: skill
            }
            
            gladiators[name] = gladiators[name] || gladiatorData;
            // console.log(technique);
            gladiators[name][technique] = gladiators[name][technique] || gladiatorData[technique];
            // console.log(gladiators[name][technique]);
            const higherValue = Math.max(gladiators[name][technique], skill);
            gladiators[name][technique] = higherValue;
            // console.log(higherValue);
          } else {
            const data = input.split(" vs ");
            const glad1 = data[0];
            const glad2 = data[1];
            // console.log(glad1, glad2);
            
            if (gladiators[glad1]) {
              if (gladiators[glad2]) {
                const glad1Techniques = Object.keys(gladiators[glad1]);
                const glad2Techniques = Object.keys(gladiators[glad2]);
                // console.log(glad1Techniques);
                // console.log(glad2Techniques);
                for (const glad1Technique of glad1Techniques) {
                  for (const glad2Technique of glad2Techniques) {
                    if (glad1Technique == glad2Technique) {
                      // console.log(glad1Technique);
                      // console.log(glad2Technique);
                      const glad1Skills = Object.values(gladiators[glad1]);
                      const glad2Skills = Object.values(gladiators[glad2]);
                      // console.log(glad1Skills);
                      // console.log(glad2Skills);
                      const glad1TotalSkills = glad1Skills.reduce((acc, skill) => {
                        return acc + skill;
                      }, 0);
                      // const glad2TotalSkills = glad2Skills.reduce((acc, skill) => {
                      //   return acc + skill;
                      // }, 0);
                      const glad2TotalSkills = glad2Skills.reduce((acc, skill) => acc + skill, 0);
                      // console.log(glad1TotalSkills);
                      // console.log(glad2TotalSkills);
                      // console.log("fight");
                      if (glad1TotalSkills > glad2TotalSkills) {
                        delete gladiators[glad2];
                      } else if (glad1TotalSkills < glad2TotalSkills) {
                        delete gladiators[glad1];
                      }
                    } else {
                      // console.log(`${glad1} and ${glad2} don't have a common technique for now.`);
                    }
                  }
                }
              } else {
                // console.log(`${glad2} doesnt exist`);
              }
            } else {
              // console.log(`${glad1} doesnt exist`);
            }
          }
          
          index++;
          input = params[index];

          // if (index > 50) {
          //   console.log("infinity");
          //   break;
          // }
        }

        const remainingGladiators = [];

        for (const gladiatorName in gladiators) {
          // console.log(gladiatorName);
          const gladSkills = Object.values(gladiators[gladiatorName]);
          const totalSkills = gladSkills.reduce((acc, skill) => {
            return acc + skill;
          }, 0);
          // gladiators[gladiator].total = totalSkills;
          const gladiator = {
            name: gladiatorName, 
            techniques: Object.entries(gladiators[gladiatorName]), 
            totalSkills
          }

          gladiator.techniques = gladiator.techniques.sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]));

          remainingGladiators.push(gladiator);
        }

        // console.log(gladiators);
        // console.log(remainingGladiators);

        const sorted = remainingGladiators.sort((a, b) => b.totalSkills - a.totalSkills);

        // console.log(sorted);

        for (const gladiator of sorted) {
          console.log(`${gladiator.name}: ${gladiator.totalSkills} skill`);
          for (const technique of gladiator.techniques) {
            console.log(`- ${technique[0]} <!> ${technique[1]}`);
          }
        }

      }

      arenaFights(
        [
          'Peter -> BattleCry -> 400', 
          'Alex -> PowerPunch -> 300',
          'Stefan -> Duck -> 200',
          'Stefan -> Tiger -> 250', 
          // 'Stefan -> Tiger -> 300', 
          'Ave Cesar'
        ]
      )
      // arenaFights(
      //   [
      //     'Peter -> Duck -> 400', 
      //     'Julius -> Shield -> 150', 
      //     'Gladius -> Heal -> 200', 
      //     'Gladius -> Support -> 250', 
      //     'Gladius -> Shield -> 250', 
      //     'Peter vs Gladius', 
      //     'Gladius vs Julius', 
      //     'Jogata vs Julius', 
      //     'Gladius vs Maximilian', 
      //     'Ave Cesar'
      //   ]
      // )

      // 10. Legendary Farming✶
    </script>
  </body>
</html>