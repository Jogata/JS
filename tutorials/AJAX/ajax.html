<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AJAX | XMLHttpRequest</title>
  </head>
  <body>
    <h1><span>AJAX</span> XMLHttpRequest(HTTPMethod, url, )</h1>
    <h1>Forecast for the Next 24 Hours</h1>
 
    <main id="container"></main>
 
    <script>
      let jogata = {
        changeColors: function(e) {
          console.log(this);
          const target = e.currentTarget;
          target.style.color = "#333";
          target.style.backgroundColor = "olive";
        }, 
        init: function() {
          let h1 = document.querySelector("h1");
          h1.addEventListener("click", this.changeColors);
        }
       }
 
      jogata.init();
    </script>
    <script>
      const container = document.getElementById("container");
      let df = new DocumentFragment();

      const darksky = 'https://api.darksky.net/forecast/';
      const key = "bc7587vgghcfgxkjldgh656vxgkv7b6a"
      const lat = 45.3483;
      const lng = -75.7584;
 
      let uri = darksky + key + "/" + lat + "," + lng;
      uri = uri.concat("?units=ca&exclude=minutely");
      console.log(uri);
 
      const options = {
        method: "GET", 
        mode: "cors"
      } 
 
      const req = new Request(uri, options);
 
      fetch(req)
        .then(response => {
          if (response.ok) {
            console.log(response);
            return response.json();
          } else {
            throw new Error("Bad HTTP!");
          }
        })
        .then((data)=>{console.log(data)}, res => {
          const response = {
            currently: {
              temperature: 0, 
              summary: "sum"
            }, 
            daily: {
              data: [{
                time: "1499918409",
              }], 
            }, 
            hourly: {
              data: [
                {
                  time: "1499918409", 
                  temperature: 15.94, 
                  summary: "Clear", 
                  precipProbability: 0.15, 
                }, 
                {
                  time: "1599918409",
                  temperature: 14.95, 
                  summary: "Sunny", 
                  precipProbability: 0.65, 
                }
              ]
            }
          }
  
          console.log("response provided");
          
          response.hourly.data.forEach(hour => {
            let div = document.createElement("div");
            div.classList.add("hour");
            let timestamp = hour.time;
            div.id = "ts" + timestamp;
            let temp = parseInt(hour.temperature);
            div.textContent = temp.toString().concat("\u00B0");
            div.title = hour.summary;
            div.style.margin = "50px";
            let span = document.createElement("span");
            span.style.display = "block";
            let timmy = new Date(timestamp * 1000);
            // span.textContent = "0:00";
            span.textContent = timmy.getHours() + ":00";
            div.appendChild(span);
            df.appendChild(div);
          });

          container.appendChild(df);
 
          response.hourly.data.filter(hour => {
            if (hour.precipProbability > 0.5) {
              return true;
            } else {
              return false;
            }
          }).map(hour => {
            return hour.time;
          }).forEach(timestamp => {
            let id = "ts" + timestamp;
            document.getElementById(id).classList.add("precip");
          })

          const highObj = response.hourly.data.reduce((acc, hour) => {
            if (hour.temperature > acc.temp) {
              return {
                temp: hour.temperature,
                time: hour.time,
              };
            } else {
              return acc;
            }
          }, {temp: -100, time: 1000});
          let id = "ts" + highObj.time;
          document.getElementById(id).classList.add("high");
        }) 
        .catch(err => {
          console.log("ERROR: ", err.message);
        }) 
    </script>

    <!-- ================= Get data from local JSON file ================= -->
    <fieldset>
      <legend>Get all users from local JSON file</legend>
      <button id="local">Send Request</button>
    </fieldset>

    <script>
      const btnLocalJSON = document.querySelector("#local");
      btnLocalJSON.addEventListener("click", getAllUsersFromLocalFile);

      function getAllUsersFromLocalFile() {
        const users = new XMLHttpRequest();

        users.onload = function () {
          if (this.status === 200) {
            try {
              const responseAsObject = JSON.parse(this.responseText);
            } catch (error) {
              console.warn('Did not parse the data!');
            }
          } else {
            console.warn('Did not receive the data!');
          }
        };
  
        users.open('get', 'users.js', true);
        users.send();
      }
    </script>

    <!-- ================= Get data from GitHub API ================= -->
    <fieldset>
      <legend>Get users from GitHub API</legend>
      <button id="github">Send Request</button>
      <span id="userGithub"></span>
    </fieldset>

    <script>
      const btnGithub = document.querySelector("#github");
      btnGithub.addEventListener("click", getUsersFromGithub);

      function getUsersFromGithub() {
        const users = new XMLHttpRequest();

        users.onload = function () {
          if (this.status === 200) {
            try {
              const usersAsArray = JSON.parse(this.responseText);
              const display = document.querySelector("#userGithub");
              const randomIndex = Math.floor(Math.random() * 30);
              display.textContent = usersAsArray[randomIndex].login;
            } catch (error) {
              console.warn('Did not parse the data!');
            }
          } else {
            console.warn('Did not receive the data!');
          }
        };
  
        users.open('get', 'https://api.github.com/users', true);
        users.send();
      }
    </script>
  </body>
</html>