<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AJAX | XMLHttpRequest</title>
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> -->
    <style>
      @import url("https://fonts.googleapis.com/css?family=Poppins");
      
      button {
        border: 1px solid transparent;
        outline: 1px solid transparent;
        background-color: transparent;
      }
      button:focus-visible {
        outline: 1px solid gray;
      }

body {
  /* width: 100%; */
  /* height: 100vh; */
  min-height: 100vh;
  font-family: "Poppins", sans-serif;
}

.accordion {
  border: 2px solid #cdc7c7;
  display: inline-block;
  width: 40%;
  font-size: 1.3rem;
  margin: 10px;
}

.accordion p {
  margin: 1em;
}

.button {
  float: right;
  background: #393636;
  padding: 0.1em 1em 0.1em 1em;
  color: white;
  cursor: pointer;
  text-transform: uppercase;
  font-weight: bold;
  letter-spacing: 3px;
}

.extra {
  display: none;
}

.head {
  background: #ccccff;
  padding: 1em;
}

      @import url("https://fonts.googleapis.com/css?family=Lato");
      @import url("https://fonts.googleapis.com/css?family=PT+Sans");

body fieldset {
  display: none;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
html {
  font-family: "PT sans", sans-serif;
  font-size: 24px;
  color: #234465;
}
body {
  display: flex;
  flex-direction: column;
  font-family: Georgia, Times, serif;
  margin: 0;
  min-height: 100vh;
  flex-wrap: wrap;
}
#main {
  background-size: cover;
  margin-top: 1%;
}
#exercise {
  width: 70%;
  float: left;
  padding: 1rem 0 1rem 1rem;
}
main:after {
  display: block;
  content: "";
  clear: both;
}
input[type="button"],
button {
  padding: 0.3rem 0.5rem;
  font-size: 0.7em;
  margin: 1rem 0 1rem 0;
  border: none;
  color: white;
  background: #234465;
  border-radius: 5px;
  outline: none;
  font-family: inherit;
}
.profile {
  border: 3px solid black;
  display: inline-block;
  margin-left: 11.7%;
  width: 13%;
  vertical-align: top;
  margin-top: 15px;
  text-align: center;
}
#down {
  border: 3px solid black;
  display: inline-block;
  margin-left: 19.9%;
  width: 13%;
  vertical-align: top;
  margin-top: 15px;
}
.userIcon {
  width: 99%;
  height: auto;
  margin: 0 auto;
}
.hiddenInfo input{
  display: inline-block;
  width: 100%;
}
.hiddenInfo input {
  width: 100%;
}
.hiddenInfo > input, .hiddenInfo > label {
  display: none;
}
button {
  border: 1px solid darkblue;
  /* background-color: cadetblue; */
  cursor: pointer;
}
button:focus-visible {
  outline: 1px solid gray;
}
    </style>
  </head>
  <body>

    <div id="container">

      <main id="main">
  
        <div class="profile">

          <img src="./iconProfile2.png" class="userIcon" />
          <label>Lock</label>
          <input type="radio" name="user1Locked" value="lock" checked>
          <label>Unlock</label>
          <input type="radio" name="user1Locked" value="unlock"><br>
          <hr>
          <label>Username</label>
          <input type="text" name="user1Username" value="" disabled readonly />

          <div class="user1Username">
            <hr>
            <label>Email:</label>
            <input type="email" name="user1Email" value="" disabled readonly />
            <label>Age:</label>
            <input type="text" name="user1Age" value="" disabled readonly />
          </div>
          
          <button>Show more</button>

        </div>
  
      </main>

    </div>
    <script>
      window.onload = lockedProfile();
    </script>
    <script>
      function lockedProfile() {
    // console.log('TODO...')
    const url = `http://localhost:3030/jsonstore/advanced/profiles`;

    // const test = {
    //     _id: "4fccdb3a-59c9-4e45-a28f-870fe5d1d8be", 
    //     age: 23, 
    //     email: "peter@users.bg", 
    //     username: "Peter"
    // }

    const callbacks = {
        "Show": show, 
        "Hide": hide,
    }

    const profileCardCallbacks = {
        "Show": showUserInfo, 
        "Hide": hideUserInfo, 
        "undefined": doNothing
    };

    const mainSec = document.getElementById("main");
    mainSec.textContent = "";
    // const userCard = document.querySelector(".profile");

    try {
        getUsers();
    } catch (error) {
        console.log(error);
    }

    async function getUsers() {
      const response = await fetch(url);
      const data = await response.json();
      // console.log(data);
      const users = Object.values(data);
      // console.log(users);

      for (let index = 0; index < users.length; index++) {
            const user = users[index];
            // console.log(user);
            const profileCard = document.createElement("div");
            profileCard.classList.add("profile");

            const html = `<img src="./iconProfile2.png" class="userIcon" /><label>Lock</label><input type="radio" name="user${index + 1}Locked" value="lock" checked><label>Unlock</label><input type="radio" name="user${index + 1}Locked" value="unlock"><br><hr><label>Username</label><input type="text" name="user${index + 1}Username" value="${user.username}" disabled readonly /><div class="user1HiddenFields" style="display: none;"><hr><label>Email:</label><input type="email" name="user${index + 1}Email" value="${user.email}" disabled readonly /><label>Age:</label><input type="text" name="user${index + 1}Age" value="${user.age}" disabled readonly /></div>`;
            const btn = document.createElement("button");
            btn.textContent = "Show more";
            profileCard.innerHTML = html;
            btn.addEventListener("click", toggleUserInfo);
            profileCard.appendChild(btn);

            profileCard.addEventListener("click", callback);

            mainSec.appendChild(profileCard);
        }

        function toggleUserInfo(e) {
            // console.log("display");
            const text = this.textContent;
            const tokens = text.split(" ");
            const callbackName = tokens[0];
            // console.log(callbackName);
            e.callbackName = callbackName;
        }

        // for (const user of users) {
            // console.log(user);
            // const userCard = document.querySelector(".profile");
            // const html = 
            // const clone = userCard.cloneNode(true);
            // const username = clone.querySelector("input:nth-of-type(3)");
            // username.value = user.username;
            // const email = clone.querySelector(".user1Username input:nth-of-type(1)");
            // email.value = user.email;
            // const age = clone.querySelector(".user1Username input:nth-of-type(2)");
            // age.value = user.age;
            // mainSec.appendChild(clone);    
        // }

        // mainSec.children[0].remove();
    
    }

    // getUsers();

    function show() {
        // console.log("show");
        this.textContent = "Hide it";
    }

    function hide() {
        // console.log("hide");
        this.textContent = "Show more";
    }

    function doNothing() {
        console.log("doNothing");
        return;
    }

    function callback(e) {
        // console.log(e.target);
        // console.log(e.callbackName);
        const checkedInput = this.querySelector("input:checked");
        // console.log(checkedInput);
        const checkedInputValue = checkedInput.value;
        // console.log(checkedInputValue);
        if (checkedInputValue == "unlock" && e.target.tagName == "BUTTON") {
            const cardCallback = profileCardCallbacks[e.callbackName];
            cardCallback.call(this);
            const btnCallback = btnCallbacks[e.callbackName];
            // console.log(btnCallback);
            // console.log(this);
            btnCallback.call(e.target);
        }
    }

    function showUserInfo() {
        // console.log(this);
        const userinfo = this.querySelector(".user1HiddenFields");
        userinfo.style.display = "block";
    }

    function hideUserInfo() {
        // console.log(this);
        const userinfo = this.querySelector(".user1HiddenFields");
        userinfo.style.display = "none";
    }

    // fetch(url)
    // .then(response => response.json())
    // .then(data => console.log(data))
    // .catch(err => console.log(err));
}
    </script>
  
    <!-- <h1><span>AJAX</span> XMLHttpRequest(HTTPMethod, url, )</h1> -->

<script>
  // 10. Contacts Builder✶
  // 11. View Model✶
  // 12. Payment Package
  // 13. String Builder *✶
</script>

    <!-- ================= Get data from local JSON file ================= -->

    <section id="main">
      <!-- <div class="accordion">
          <div class="head">
              <span>Scalable Vector Graphics</span>
              <button class="button" id="ee9823ab-c3e8-4a14-b998-8c22ec246bd3">More</button>
          </div>
          <div class="extra">
              <p>Scalable Vector Graphics .....</p>
          </div>
      </div> -->
  </section>

    <script>
      function solution() {
    //TODO .....
    const url = `http://localhost:3030/jsonstore/advanced/articles/list`;

    createAccordions();

    // var test = {
    //     _id: 5, 
    //     title: "test"
    // }

    async function createAccordions() {
        try {
            const data = await getAccordions();
            // console.log(data);

            const main = document.getElementById("main");

            for (const accordionData of data) {
                // console.log(accordionData);
                // const id = accordionData._id;
                // const title = accordionData.title;

                const accordion = createAccordion(accordionData);
                const btn = accordion.querySelector("button");
                // console.log(btn);
                btn.addEventListener("click", async function() {
                    // console.log(this);
                    // console.log(this.id);
                    
                    try {
                        const url = `http://localhost:3030/jsonstore/advanced/articles/details/${this.id}`;

                        // var test = {
                        //     id: 5, 
                        //     title: "test", 
                        //     content: "tets content"
                        // }

                        const response = await fetch(url);

                        if (!response.ok) {
                          throw new Error();
                        }

                        const data = await response.json();
                        // console.log(data);
                        const para = accordion.querySelector(".extra p");
                        para.textContent = data.content;
                        
                    } catch (error) {
                        console.log(error);
                    }
                })

                btn.addEventListener("click", () => {
                    // console.log(btn);
                    const content = accordion.querySelector(".extra");
                    if (btn.textContent == "More") {
                        btn.textContent = "Less";
                        content.style.display = "block";
                    } else {
                        btn.textContent = "More";
                        content.style.display = "none";
                    }
                })

                main.appendChild(accordion);

            }
        } catch (error) {
            console.log(error);
        }
    }

    function createAccordion(data) {
        const div = document.createElement("div");
        div.classList.add("accordion");
        const html = `<div class="head"><span>${data.title}</span><button class="button" id="${data._id}">More</button></div><div class="extra"><p></p></div>`;
        div.innerHTML = html;
        return div;
    }

    async function getAccordions() {

        try {
            const response = await fetch(url);

            if (!response.ok) {
                throw new Error();
            }

            const data = await response.json();
            // console.log(data);
            return data;            
        } catch (error) {
            console.log(error);
        }
    }

    // fetch(url)
    // .then(response => response.json())
    // .then(data => console.log(data))
    // .catch(err => console.log(err));
}

solution();
// window.addEventListener("DOMContentLoaded", solution);
    </script>

    <div id="content" style="display: none;">
      <div id="request">
          <input id="location" class='bl' type="text">
          <input id="submit" class="bl" type="button" value="Get Weather">
      </div>
      <div id="forecast" style="display:none">
          <div id="current">
              <div class="label">Current conditions</div>
              <!-- <div class="forecasts">
                  <span class="condition symbol"></span>
                  <span class="condition">
                      <span class="forecast-data">london, usa</span>
                      <span class="forecast-data">8deg/19deg</span>
                      <span class="forecast-data">sunny</span>
                  </span>
              </div> -->
          </div>
          <div id="upcoming">
              <div class="label">Three-day forecast</div>
              <!-- <div class="forecast-info">
                  <span class="upcoming">
                      <span class="symbol"></span>
                      <span class="forecast-data">8deg/19deg</span>
                      <span class="forecast-data">sunny</span>
                  </span>
                  <span class="upcoming">
                      <span class="symbol"></span>
                      <span class="forecast-data">8deg/19deg</span>
                      <span class="forecast-data">sunny</span>
                  </span>
                  <span class="upcoming">
                      <span class="symbol"></span>
                      <span class="forecast-data">8deg/19deg</span>
                      <span class="forecast-data">sunny</span>
                  </span>
              </div> -->
          </div>
      </div>
  </div>

<script>
function attachEvents() {
    // console.log("TODO...");
    const submitbtn = document.getElementById("submit");
    const forecastoutput = document.getElementById("forecast");
    
    submitbtn.addEventListener("click", async () => {
        try {
            const locationInput = document.getElementById("location");
            const locationvalue = locationInput.value;

            if (locationvalue.length == 0) {
                throw new Error();
            }

            const response = await fetch("http://localhost:3030/jsonstore/forecaster/locations");

            if (!response.ok) {
                throw new Error();
            }

            const locationsdata = await response.json();
            // console.log(locationsdata);
            const data = Object.entries(locationsdata);
            // console.log(data);

            const location = data.find(x => x[1].name == locationvalue);
            // console.log(location);

            if (!location) {
                throw new Error();
            }

            const code = location[1].code;
            // console.log(code);

            const todayInfoURL = `http://localhost:3030/jsonstore/forecaster/today/${code}`;
            
            const todayInfoResponse = await fetch(todayInfoURL);
            
            const todayInfo = await todayInfoResponse.json();
            // console.log(todayInfo);
            
            const upcomingInfoURL = `http://localhost:3030/jsonstore/forecaster/upcoming/${code}`;

            const upcomingInfoResponse = await fetch(upcomingInfoURL);

            const upcomingInfo = await upcomingInfoResponse.json();
            // console.log(upcomingInfo);

            forecastoutput.style.display = "block";

            const symbols = {
                "Sunny": "&#x2600;", // ☀
                "Partly sunny": "&#x26C5;", // ⛅
                "Overcast": "&#x2601;", // ☁
                "Rain": "&#x2614;", // ☂
                "Degrees": "&#176;" // °
            }
            // console.log(symbols);

            const forecastsDiv = document.createElement("div");
            forecastsDiv.classList.add("forecasts");
            const forecastsHtml = `<span class="condition symbol">${symbols[todayInfo.forecast.condition]}</span><span class="condition"><span class="forecast-data">${todayInfo.name}</span><span class="forecast-data">${todayInfo.forecast.low}${symbols.Degrees}/${todayInfo.forecast.high}${symbols.Degrees}</span><span class="forecast-data">${todayInfo.forecast.condition}</span></span>`;
            forecastsDiv.innerHTML = forecastsHtml;

            const todayWeatherView = document.getElementById("current");
            todayWeatherView.appendChild(forecastsDiv);

            const upcomingDiv = document.createElement("div");
            upcomingDiv.classList.add("forecast-info");

            for (const day of upcomingInfo.forecast) {
                // console.log(day);
                const span = createOneDayInfo(day.condition, day.low, day.high);
                // console.log(span.children);
                upcomingDiv.appendChild(span);
            }

            const upcomingWeatherView = document.getElementById("upcoming");
            upcomingWeatherView.appendChild(upcomingDiv);

        //     `<div class="forecast-info">
        //     <span class="upcoming">
        //         <span class="symbol"></span>
        //         <span class="forecast-data">8deg/19deg</span>
        //         <span class="forecast-data">sunny</span>
        //     </span>
        //     <span class="upcoming">
        //         <span class="symbol"></span>
        //         <span class="forecast-data">8deg/19deg</span>
        //         <span class="forecast-data">sunny</span>
        //     </span>
        //     <span class="upcoming">
        //         <span class="symbol"></span>
        //         <span class="forecast-data">8deg/19deg</span>
        //         <span class="forecast-data">sunny</span>
        //     </span>
        // </div>`

        function createOneDayInfo(condition, low, high) {
            const span = document.createElement("span");
            span.classList.add("upcoming");
            const html = `<span class="symbol">${symbols[condition]}</span><span class="forecast-data">${low}${symbols.Degrees}/${high}${symbols.Degrees}</span><span class="forecast-data">${condition}</span>`;
            // console.log(html);
            span.innerHTML = html;
            return span;
        }

        } catch (error) {
            forecastoutput.textContent = "Error";
            forecastoutput.style.display = "block";
        }
    });

    // function getLocations(url) {
    //     fetch(url)
    //     .then(response => response.json())
    //     .then(data => console.log(data))
    //     .catch(err => console.log(err));
    // }
}

attachEvents();
</script>

    <fieldset>
      <legend>Get all users from local JSON file</legend>
      <button id="local">Send Request</button>
    </fieldset>

    <script>
      const btnLocalJSON = document.querySelector("#local");
      btnLocalJSON.addEventListener("click", getAllUsersFromLocalFile);

      function getAllUsersFromLocalFile() {
        const users = new XMLHttpRequest();

        users.onload = function () {
          if (this.status === 200) {
            try {
              const responseAsObject = JSON.parse(this.responseText);
            } catch (error) {
              console.warn('Did not parse the data!');
            }
          } else {
            console.warn('Did not receive the data!');
          }
        };
  
        users.open('get', 'users.js', true);
        users.send();
      }
    </script>

    <!-- ================= Get data from GitHub API ================= -->
    <fieldset>
      <legend>Get users from GitHub API</legend>
      <button id="github">Send Request</button>
      <span id="userGithub"></span>
    </fieldset>

    <script>
      const btnGithub = document.querySelector("#github");
      btnGithub.addEventListener("click", getUsersFromGithub);

      function getUsersFromGithub() {
        const users = new XMLHttpRequest();

        users.onload = function () {
          if (this.status === 200) {
            try {
              const usersAsArray = JSON.parse(this.responseText);
              const display = document.querySelector("#userGithub");
              const randomIndex = Math.floor(Math.random() * 30);
              display.textContent = usersAsArray[randomIndex].login;
            } catch (error) {
              console.warn('Did not parse the data!');
            }
          } else {
            console.warn('Did not receive the data!');
          }
        };
  
        users.open('get', 'https://api.github.com/users', true);
        users.send();
      }
    </script>

    <script>
      const matches4 = `
      40 Desert Blade (Fragment)
40 Minotaur's Head (Fragment)
40 Diviner's Orb - Recipe (Fragment)
50 Panoptic Orb - Recipe (Fragment)
80 Hand of Glory (Fragment)

40 Book of Prophecies - Recipe (Fragment)
50 Book of Fate - Recipe (Fragment)
80 Flaming Heart (Fragment)
160 Pastor's Seal (Fragment)

80 Riversar's Tiara (Fragment)
`;
      const matches3 = `740/120/100      640/320/150`;

const patern = /[0-9]+/g;

const result = matches3.match(patern).reduce((acc, n) => acc + Number(n), 0);
console.log(result);
    </script>
  </body>
</html>