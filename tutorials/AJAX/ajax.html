<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AJAX | XMLHttpRequest</title>
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> -->
    <style>
      @import url(https://fonts.googleapis.com/css?family=Open+Sans);
body {
    font-family: 'Open Sans', serif;
}
select {
    padding: 10px 15px;
    margin: 8px 0;
    display: inline-block;
    border: 1px solid #ccc;
    border-radius: 4px;
}
button {
    background-color: #4CAF50;
    color: white;
    padding: 10px 15px;
    margin: 8px 0;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}
    </style>
  </head>
  <body>
    <!-- <h1><span>AJAX</span> XMLHttpRequest(HTTPMethod, url, )</h1> -->

    <h1>All Posts</h1>
    <button id="btnLoadPosts">Load Posts</button>
    <select id="posts"></select>
    <button id="btnViewPost">View</button>
    <h1 id="post-title">Post Details</h1>
    <p id="post-body"></p>
    <h2>Comments</h2>
    <ul id="post-comments"></ul>

    <script>
      function attachEvents() {
    // console.log('TODO...');

    const postsURL = `http://localhost:3030/jsonstore/blog/posts`;
    const commentsURL = `http://localhost:3030/jsonstore/blog/comments`;
    const commentURL = `http://localhost:3030/jsonstore/blog/comments/:id`;

    let posts = null;

    const loadPostsBtn = document.getElementById("btnLoadPosts");
    loadPostsBtn.addEventListener("click", async () => {
        await getPostsData();
        addOptions();
    });

    const loadPostBtn = document.getElementById("btnViewPost");
    loadPostBtn.addEventListener("click", () => {
        const select = document.getElementById("posts");
        const postID = select.value;
        // console.log(selectedValue);
        const post = getPost(postID);
        // console.log(postID);
        // const post = getPost(postID);
        // console.log(post);
        loadPost(post);
        loadComments(postID);
    });

    async function getPostsData() {
        
        try {
            const response = await fetch(postsURL);

            if (!response.ok) {
                throw new Error();
            }

            const data = await response.json();
            // console.log(data);
            // const postsData = Object.values(data);
            // console.log(posts);
            posts = Object.values(data);
            // console.log(posts);
            // console.log(postsData);

            // return postsData;

        } catch (error) {
            console.log(error);
        }
    }

    function getPost(id) {
        const post = posts.find(post => post.id == id);
        return post;
    }

    function loadPost(post) {
        const title = post.title;
        const postTitle = document.getElementById("post-title");
        postTitle.textContent = title;
        const body = post.body;
        const postBody = document.getElementById("post-body");
        postBody.textContent = body;
    }

    async function loadComments(id) {
        const allComments = await getCommentsData();
        // console.log(comments);
        const postComments = allComments.filter(comment => comment.postId == id);
        // console.log(postComments);
        const commentsUL = document.getElementById("post-comments");
        commentsUL.textContent = "";

        for (const comment of postComments) {
            // console.log(comment);
            createComment(comment, commentsUL);
        }
    }

    function createComment(data, parent) {
        const li = document.createElement("li");
        li.textContent = data.text;
        // const commentsUL = document.getElementById("post-comments");
        parent.appendChild(li);
    }

    async function getCommentsData() {
        
        try {
            const response = await fetch(commentsURL);

            if (!response.ok) {
                throw new Error();
            }

            const data = await response.json();
            // console.log(data);
            const commentsData = Object.values(data);
            // console.log(commentsData);

            return commentsData;

        } catch (error) {
            console.log(error);
            return null;
        }
    }

    function addOptions() {
        const select = document.getElementById("posts");

        for (const post of posts) {
            // console.log(post);
            const option = createOptionTag(post.id, post.title);
            select.appendChild(option);
        }
    }

    function createOptionTag(value, text) {
        const option = document.createElement("option");
        option.text = text;
        option.value = value;
        return option;
    }

    var testPost = {
        body: "post body", 
        id: 5, 
        title: "post title"
    }

    var testComment = {
        id: 5, 
        postId: "comment body", 
        text: "comment text"
    }

    // fetch(postsURL)
    // .then(response => response.json())
    // .then(data => console.log(data))
    // .catch(err => console.log(err));

    // fetch(commentsURL)
    // .then(response => response.json())
    // .then(data => console.log(data))
    // .catch(err => console.log(err));
    
}

attachEvents();
    </script>

<script>
  // 10. Contacts Builder✶
  // 11. View Model✶
  // 12. Payment Package
  // 13. String Builder *✶
</script>

    <!-- ================= Get data from local JSON file ================= -->

    <fieldset>
      <legend>Get all users from local JSON file</legend>
      <button id="local">Send Request</button>
    </fieldset>

    <script>
      const btnLocalJSON = document.querySelector("#local");
      btnLocalJSON.addEventListener("click", getAllUsersFromLocalFile);

      function getAllUsersFromLocalFile() {
        const users = new XMLHttpRequest();

        users.onload = function () {
          if (this.status === 200) {
            try {
              const responseAsObject = JSON.parse(this.responseText);
            } catch (error) {
              console.warn('Did not parse the data!');
            }
          } else {
            console.warn('Did not receive the data!');
          }
        };
  
        users.open('get', 'users.js', true);
        users.send();
      }
    </script>

    <!-- ================= Get data from GitHub API ================= -->
    <fieldset>
      <legend>Get users from GitHub API</legend>
      <button id="github">Send Request</button>
      <span id="userGithub"></span>
    </fieldset>

    <script>
      const btnGithub = document.querySelector("#github");
      btnGithub.addEventListener("click", getUsersFromGithub);

      function getUsersFromGithub() {
        const users = new XMLHttpRequest();

        users.onload = function () {
          if (this.status === 200) {
            try {
              const usersAsArray = JSON.parse(this.responseText);
              const display = document.querySelector("#userGithub");
              const randomIndex = Math.floor(Math.random() * 30);
              display.textContent = usersAsArray[randomIndex].login;
            } catch (error) {
              console.warn('Did not parse the data!');
            }
          } else {
            console.warn('Did not receive the data!');
          }
        };
  
        users.open('get', 'https://api.github.com/users', true);
        users.send();
      }
    </script>

    <script>
      const matches4 = `
      40 Desert Blade (Fragment)
40 Minotaur's Head (Fragment)
40 Diviner's Orb - Recipe (Fragment)
50 Panoptic Orb - Recipe (Fragment)
80 Hand of Glory (Fragment)

40 Book of Prophecies - Recipe (Fragment)
50 Book of Fate - Recipe (Fragment)
80 Flaming Heart (Fragment)
160 Pastor's Seal (Fragment)

80 Riversar's Tiara (Fragment)
`;
      const matches3 = `740/120/100      640/320/150`;

const patern = /[0-9]+/g;

const result = matches3.match(patern).reduce((acc, n) => acc + Number(n), 0);
console.log(result);
    </script>
  </body>
</html>